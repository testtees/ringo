<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªãƒ³ã‚´ã¨çˆ†å¼¾ã‚²ãƒ¼ãƒ </title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ³ãƒˆã¨åŸºæœ¬è¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* ãƒ€ãƒ¼ã‚¯ãªèƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤ºã« */
        }
        canvas {
            background-color: #2d3748; /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ã®èƒŒæ™¯è‰² */
            display: block;
            border-radius: 1rem; /* è§’ã‚’ä¸¸ãã™ã‚‹ */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3); /* å½± */
            touch-action: manipulation; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®æœ€é©åŒ– */
        }
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .game-button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* å®Œå…¨ãªä¸¸è§’ */
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-image: linear-gradient(to right, #4CAF50, #8BC34A); /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
            border: none;
            outline: none;
        }
        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-image: linear-gradient(to right, #8BC34A, #4CAF50);
        }
        .game-button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ */
        .mobile-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            position: absolute;
            bottom: 2rem;
            width: 100%;
        }
        .mobile-controls button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 4rem; /* 2rem -> 4rem ã«å¤‰æ›´ (2å€) */
            width: 8rem; /* 4rem -> 8rem ã«å¤‰æ›´ (2å€) */
            height: 8rem; /* 4rem -> 8rem ã«å¤‰æ›´ (2å€) */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .mobile-controls button:hover {
            opacity: 1;
        }
        @media (min-width: 768px) {
            .mobile-controls {
                display: none; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯éè¡¨ç¤º */
            }
        }

        /* ã‚¹ã‚³ã‚¢å¼·èª¿è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @keyframes pulse-highlight {
            0% { transform: scale(1); opacity: 1; color: #fcd34d; }
            50% { transform: scale(1.25); opacity: 0.9; color: #ffeb3b; } /* ã‚ˆã‚Šå¤§ããã€æ˜ã‚‹ã„é»„è‰²ã« */
            100% { transform: scale(1); opacity: 1; color: #fcd34d; }
        }

        .text-milestone-highlight {
            font-size: 3.5rem; /* ã‚ˆã‚Šå¤§ãã */
            color: #fcd34d; /* é»„è‰²ã«å¼·èª¿ */
            animation: pulse-highlight 0.5s ease-out; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ */
            text-shadow: 0 0 15px rgba(255, 235, 59, 0.9); /* å…‰ã‚‹ã‚ˆã†ãªå½±ã€ã‚ˆã‚Šå¼·èª¿ */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div class="flex flex-col items-center justify-center bg-gray-800 rounded-2xl p-6 shadow-2xl relative">
        <h1 class="text-xl sm:text-2xl md:text-3xl font-extrabold text-green-400 mb-4 tracking-wide whitespace-nowrap">ğŸ ãƒªãƒ³ã‚´ã¨çˆ†å¼¾ã‚²ãƒ¼ãƒ  ğŸ’£</h1>
        <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’gameUIã®å¤–ã«ç§»å‹•ã—ã€å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´ -->
        <p id="scoreDisplay" class="text-lg sm:text-xl md:text-2xl font-bold mb-4 text-white z-10 whitespace-nowrap">ã‚¹ã‚³ã‚¢: 0 / æ¬¡ã®ç›®æ¨™: 5 / 1.0å€</p>
        <canvas id="gameCanvas" class="w-full max-w-lg aspect-square"></canvas>
        <div id="gameUI" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 bg-opacity-90 rounded-2xl text-white text-center p-4" style="display: flex;">
            <p id="messageDisplay" class="text-xl sm:text-2xl lg:text-2xl mb-8">çˆ†å¼¾ã‚’é¿ã‘ãªãŒã‚‰ãƒªãƒ³ã‚´ã‚’é›†ã‚ã‚ˆã†ï¼</p>
            <button id="startButton" class="game-button">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="mobile-controls">
        <button id="moveLeftBtn">â†</button>
        <button id="moveRightBtn">â†’</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameUI = document.getElementById('gameUI');
        const startButton = document.getElementById('startButton');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const messageDisplay = document.getElementById('messageDisplay');

        const moveLeftBtn = document.getElementById('moveLeftBtn');
        const moveRightBtn = document.getElementById('moveRightBtn');

        let animationFrameId;
        let gameRunning = false;
        let score = 0; // å®Ÿéš›ã®å¾—ç‚¹ï¼ˆå€ç‡é©ç”¨æ¸ˆã¿ï¼‰
        let rawAppleCount = 0; // å–å¾—ã—ãŸãƒªãƒ³ã‚´ã®ç”Ÿã®æ•°ï¼ˆãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã®å¾—ç‚¹è¨ˆç®—ç”¨ã€ãŠã‚ˆã³ç”Ÿæˆæ•°ç”¨ï¼‰
        let currentMultiplier = 1.0; // å€ç‡

        // Web Audio API ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // BGMé–¢é€£å¤‰æ•°
        let bgmOscillator = null;
        let bgmGainNode = null;

        // åŠ¹æœéŸ³ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç”¨å¤‰æ•°
        let lastCollectSoundTime = 0;
        let lastAppleSpawnSoundTime = 0;
        const SOUND_COOLDOWN = 50; // 50ãƒŸãƒªç§’ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

        // ã‚²ãƒ¼ãƒ ã®è¨­å®š
        const GAME_WIDTH = 400; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åŸºæº–å¹…
        const GAME_HEIGHT = 500; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åŸºæº–é«˜ã•

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
        const PLAYER_WIDTH = 50;
        const PLAYER_HEIGHT = 50;
        const PLAYER_SPEED = 6; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•é€Ÿåº¦

        let player = {
            x: 0, // åˆæœŸåŒ–æ™‚ã«è¨­å®š
            y: 0, // åˆæœŸåŒ–æ™‚ã«è¨­å®š
            width: PLAYER_WIDTH,
            height: PLAYER_HEIGHT,
            dx: 0 // ç§»å‹•æ–¹å‘ (-1: å·¦, 1: å³, 0: åœæ­¢)
        };

        // ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆãƒªãƒ³ã‚´ã¨çˆ†å¼¾ï¼‰ã®è¨­å®š
        const ITEM_WIDTH = 30;
        const ITEM_HEIGHT = 30;
        const REGULAR_APPLE_VALUE = 3; // é€šå¸¸ãƒªãƒ³ã‚´ã®åŸºæœ¬å¾—ç‚¹
        const YELLOW_APPLE_VALUE_MULTIPLIER = 2; // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã¯é€šå¸¸ã®2å€å¾—ç‚¹

        let initialItemSpeed = 4; // åˆæœŸè½ä¸‹é€Ÿåº¦
        const MAX_ITEM_SPEED = 7;     // æœ€å¤§è½ä¸‹é€Ÿåº¦ã‚’èª¿æ•´

        let items = []; // ç”»é¢ä¸Šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        let itemGenerationTimer = 0;
        const INITIAL_ITEM_GENERATION_INTERVAL = 60; // åˆæœŸã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆã®é–“éš”ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ•°ï¼‰
        let currentItemGenerationInterval = INITIAL_ITEM_GENERATION_INTERVAL;

        // ã‚¹ã‚³ã‚¢ã«ã‚ˆã‚‹é›£æ˜“åº¦ä¸Šæ˜‡ã®é–¾å€¤ (ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹)
        let currentMilestoneBaseRawCount = 5; // åˆæœŸãƒªãƒ³ã‚´æ•°ãƒ™ãƒ¼ã‚¹ã®ç›®æ¨™
        let nextMilestoneScoreTarget = 0; // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢æ›ç®—ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç›®æ¨™ (åˆæœŸåŒ–æ™‚ã«è¨ˆç®—)

        // å€ç‡ã®ä¸Šæ˜‡é‡è¨­å®š
        const BASE_MULTIPLIER_INCREASE = 0.2; // åŸºæœ¬ã®å€ç‡å¢—åŠ é‡
        let milestoneCount = 0; // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆå›æ•°ï¼ˆå€ç‡è¨ˆç®—ç”¨ï¼‰

        // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ç”Ÿæˆç”¨å¤‰æ•°
        let bonusApplesToGenerate = 0;
        const BONUS_APPLE_GENERATION_RATE = 1; // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«1ã¤ç”Ÿæˆ (å¤§å¹…ã«çŸ­ç¸®)

        // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿé–¢æ•°
        function playSound(frequency, duration, type = 'sine', volume = 0.5, delay = 0) {
            if (!audioContext) return;

            setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                // éŸ³ãŒæ€¥ã«æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }, delay);
        }

        // ãƒªãƒ³ã‚´å–å¾—æ™‚ã®åŠ¹æœéŸ³
        function playCollectSound() {
            const now = audioContext.currentTime * 1000; // ç¾åœ¨æ™‚åˆ»ã‚’ãƒŸãƒªç§’ã«å¤‰æ›
            if (now - lastCollectSoundTime < SOUND_COOLDOWN) {
                return; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã®å ´åˆã¯å†ç”Ÿã—ãªã„
            }
            lastCollectSoundTime = now; // æœ€çµ‚å†ç”Ÿæ™‚åˆ»ã‚’æ›´æ–°
            playSound(600, 0.08, 'sine', 0.4);
        }

        // ãƒªãƒ³ã‚´ç”Ÿæˆæ™‚ã®åŠ¹æœéŸ³
        function playAppleSpawnSound() {
            const now = audioContext.currentTime * 1000; // ç¾åœ¨æ™‚åˆ»ã‚’ãƒŸãƒªç§’ã«å¤‰æ›
            if (now - lastAppleSpawnSoundTime < SOUND_COOLDOWN) {
                return; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã®å ´åˆã¯å†ç”Ÿã—ãªã„
            }
            lastAppleSpawnSoundTime = now; // æœ€çµ‚å†ç”Ÿæ™‚åˆ»ã‚’æ›´æ–°
            playSound(200, 0.05, 'triangle', 0.2);
        }

        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆæ™‚ã®åŠ¹æœéŸ³ï¼ˆå°„å¹¸å¿ƒã‚’ç…½ã‚‹æ„Ÿã˜ï¼‰
        function playMilestoneSound() {
            // ä¸Šæ˜‡ã™ã‚‹ã‚¢ãƒ«ãƒšã‚¸ã‚ªã¨å°‘ã—è¤‡é›‘ãªéŸ³
            const baseFreq = 440;
            const duration = 0.08;
            const volume = 0.6;
            const delay = 50; // ms

            playSound(baseFreq, duration, 'square', volume, 0); // A4
            playSound(baseFreq * 1.189, duration, 'square', volume, delay); // C#5 (ç´„+3åŠéŸ³)
            playSound(baseFreq * 1.498, duration, 'square', volume, delay * 2); // E5 (ç´„+7åŠéŸ³)
            playSound(baseFreq * 2, duration, 'square', volume * 1.2, delay * 3); // A5 (ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šã€å°‘ã—å¼·èª¿)
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®åŠ¹æœéŸ³
        function playGameOverSound() {
            playSound(150, 0.3, 'sawtooth', 0.7); // ä½ã‚ã®ä¸å”å’ŒéŸ³
            setTimeout(() => playSound(100, 0.4, 'sawtooth', 0.7), 150);
        }

        // BGMé–‹å§‹é–¢æ•°
        function startBGM() {
            if (bgmOscillator) return; // æ—¢ã«BGMãŒå†ç”Ÿä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„

            bgmOscillator = audioContext.createOscillator();
            bgmGainNode = audioContext.createGain();

            bgmOscillator.type = 'sine'; // æ­£å¼¦æ³¢ã§æ»‘ã‚‰ã‹ã«
            bgmOscillator.frequency.setValueAtTime(100, audioContext.currentTime); // ä½ã‚ã®å‘¨æ³¢æ•°
            bgmGainNode.gain.setValueAtTime(0.03, audioContext.currentTime); // éå¸¸ã«å°ã•ãªéŸ³é‡

            bgmOscillator.connect(bgmGainNode);
            bgmGainNode.connect(audioContext.destination);

            bgmOscillator.loop = true; // BGMã‚’ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
            bgmOscillator.start(); // ä¿®æ­£æ¸ˆã¿
        }

        // BGMåœæ­¢é–¢æ•°
        function stopBGM() {
            if (bgmOscillator) {
                bgmOscillator.stop();
                bgmOscillator.disconnect();
                bgmOscillator = null;
                bgmGainNode = null;
            }
        }


        // åˆæœŸåŒ–å‡¦ç†
        function initializeGame() {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã«è¨­å®š
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            score = 0;
            rawAppleCount = 0; // ãƒªã‚»ãƒƒãƒˆ
            currentMultiplier = 1.0; // å€ç‡ã‚’ãƒªã‚»ãƒƒãƒˆ
            items = [];
            initialItemSpeed = 4; // é€Ÿåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentItemGenerationInterval = INITIAL_ITEM_GENERATION_INTERVAL; // ç”Ÿæˆé–“éš”ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentMilestoneBaseRawCount = 5; // åˆæœŸãƒªãƒ³ã‚´æ•°ãƒ™ãƒ¼ã‚¹ã®ç›®æ¨™ã‚’ãƒªã‚»ãƒƒãƒˆ
            milestoneCount = 0; // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            bonusApplesToGenerate = 0; // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸä½ç½®ã‚’å®Ÿéš›ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦è¨­å®š
            player.x = (canvas.width / (window.devicePixelRatio || 1)) / 2 - PLAYER_WIDTH / 2;
            player.y = (canvas.height / (window.devicePixelRatio || 1)) - PLAYER_HEIGHT - 20; // ç”»é¢ä¸‹éƒ¨ã‹ã‚‰å°‘ã—ä¸Š
            player.dx = 0;
            
            // åˆå›ã® nextMilestoneScoreTarget ã‚’è¨ˆç®—
            nextMilestoneScoreTarget = Math.floor(currentMilestoneBaseRawCount * currentMultiplier);

            updateScoreDisplay(); // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°
            // å¼·èª¿ã‚¯ãƒ©ã‚¹ã‚’ç¢ºå®Ÿã«å‰Šé™¤
            scoreDisplay.classList.remove('text-milestone-highlight');
            messageDisplay.textContent = `çˆ†å¼¾ã‚’é¿ã‘ãªãŒã‚‰ãƒªãƒ³ã‚´ã‚’é›†ã‚ã‚ˆã†ï¼`;
            gameUI.style.display = 'flex'; // UIã‚’è¡¨ç¤º
            startButton.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
            gameRunning = false; // ã‚²ãƒ¼ãƒ åœæ­¢çŠ¶æ…‹

            // UIè¡¨ç¤ºä¸­ã§ã‚‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«åˆå›æç”»
            draw();
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†
        function resizeCanvas() {
            const container = canvas.parentElement;
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;

            // å¹…ã‚’åŸºæº–ã«é«˜ã•ã‚’è¨­å®š (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒ)
            canvas.width = Math.min(GAME_WIDTH, containerWidth);
            canvas.height = Math.min(GAME_HEIGHT, containerWidth * (GAME_HEIGHT / GAME_WIDTH));

            // DPIã«å¯¾å¿œã™ã‚‹ãŸã‚ã«è§£åƒåº¦ã‚’èª¿æ•´ (ã“ã‚Œã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°è§£åƒåº¦ã§ã‚ã‚Šã€è¡¨ç¤ºã‚µã‚¤ã‚ºã§ã¯ãªã„)
            const dpr = window.devicePixelRatio || 1;
            canvas.style.width = `${canvas.width}px`;
            canvas.style.height = `${canvas.height}px`;
            canvas.width = canvas.width * dpr;
            canvas.height = canvas.height * dpr;
            ctx.scale(dpr, dpr);

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®ã‚’å†èª¿æ•´
            player.x = (canvas.width / (window.devicePixelRatio || 1)) / 2 - PLAYER_WIDTH / 2;
            player.y = (canvas.height / (window.devicePixelRatio || 1)) - PLAYER_HEIGHT - 20;
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        startButton.addEventListener('click', startGame);

        function startGame() {
            if (gameRunning) return; // æ—¢ã«ã‚²ãƒ¼ãƒ ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„

            gameRunning = true;
            score = 0;
            rawAppleCount = 0; // ãƒªã‚»ãƒƒãƒˆ
            currentMultiplier = 1.0; // å€ç‡ã‚’ãƒªã‚»ãƒƒãƒˆ
            items = [];
            initialItemSpeed = 4; // é€Ÿåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentItemGenerationInterval = INITIAL_ITEM_GENERATION_INTERVAL; // ç”Ÿæˆé–“éš”ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentMilestoneBaseRawCount = 5; // åˆæœŸãƒªãƒ³ã‚´æ•°ãƒ™ãƒ¼ã‚¹ã®ç›®æ¨™ã‚’ãƒªã‚»ãƒƒãƒˆ
            milestoneCount = 0; // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            bonusApplesToGenerate = 0; // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ

            player.x = canvas.width / (window.devicePixelRatio || 1) / 2 - PLAYER_WIDTH / 2;
            player.dx = 0;
            
            // åˆå›ã® nextMilestoneScoreTarget ã‚’è¨ˆç®—
            nextMilestoneScoreTarget = Math.floor(currentMilestoneBaseRawCount * currentMultiplier);

            updateScoreDisplay(); // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°
            // å¼·èª¿ã‚¯ãƒ©ã‚¹ã‚’ç¢ºå®Ÿã«å‰Šé™¤
            scoreDisplay.classList.remove('text-milestone-highlight');
            messageDisplay.textContent = ''; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            gameUI.style.display = 'none'; // UIã‚’éè¡¨ç¤º

            startBGM(); // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«BGMã‚’å†ç”Ÿ

            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId); // å‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            }
            gameLoop(); // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
        }

        // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateScoreDisplay() {
            const displayedScore = Math.floor(score); // å€ç‡é©ç”¨æ¸ˆã¿ãªã®ã§ãã®ã¾ã¾è¡¨ç¤º
            const displayedNextTarget = Math.floor(nextMilestoneScoreTarget); // ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ãªã®ã§ãã®ã¾ã¾è¡¨ç¤º
            
            scoreDisplay.textContent = `ã‚¹ã‚³ã‚¢: ${displayedScore} / æ¬¡ã®ç›®æ¨™: ${displayedNextTarget} / ${currentMultiplier.toFixed(1)}å€`;
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(animationFrameId); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
            playGameOverSound(); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³ã‚’å†ç”Ÿ
            stopBGM(); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«BGMã‚’åœæ­¢

            messageDisplay.textContent = `ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ã‚¹ã‚³ã‚¢: ${Math.floor(score)}`; // æœ€çµ‚ã‚¹ã‚³ã‚¢
            scoreDisplay.textContent = `ã‚¹ã‚³ã‚¢: ${Math.floor(score)}`; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã¯ç›®æ¨™ã¨å€ç‡è¡¨ç¤ºã‚’ãªãã™
            gameUI.style.display = 'flex'; // UIã‚’è¡¨ç¤º
        }

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            update();
            draw();
            if (gameRunning) {
                animationFrameId = requestAnimationFrame(gameLoop);
            }
        }

        // æ›´æ–°å‡¦ç†
        function update() {
            if (!gameRunning) return;

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•
            player.x += player.dx * PLAYER_SPEED;
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã«åˆ¶é™
            player.x = Math.max(0, Math.min(player.x, canvas.width / (window.devicePixelRatio || 1) - player.width));

            // ã‚¢ã‚¤ãƒ†ãƒ ã®ç”Ÿæˆ (é€šå¸¸ç”Ÿæˆã¨ãƒœãƒ¼ãƒŠã‚¹ç”Ÿæˆ)
            itemGenerationTimer++;
            // é€šå¸¸ã®ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
            if (itemGenerationTimer >= currentItemGenerationInterval) {
                createItem();
                itemGenerationTimer = 0;
            }

            // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã®æ®µéšçš„ç”Ÿæˆ
            if (bonusApplesToGenerate > 0) {
                // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Š2å€‹ç”Ÿæˆ (ä»¥å‰ã®ã€ŒåŠåˆ†ã®æœŸé–“ã€ã‚’ç¶­æŒ)
                const applesToGenerateThisFrame = Math.min(bonusApplesToGenerate, 2);
                for (let j = 0; j < applesToGenerateThisFrame; j++) {
                    createItem('apple', true); // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã‚’ç”Ÿæˆ
                }
                bonusApplesToGenerate -= applesToGenerateThisFrame;
            }


            // ã‚¢ã‚¤ãƒ†ãƒ ã®æ›´æ–°ã¨è¡çªåˆ¤å®š
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                item.y += item.speed; // è½ä¸‹

                // è¡çªåˆ¤å®š (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚¢ã‚¤ãƒ†ãƒ )
                if (
                    player.x < item.x + item.width &&
                    player.x + player.width > item.x &&
                    player.y < item.y + item.height &&
                    player.y + player.height > item.y
                ) {
                    if (item.type === 'apple') {
                        if (item.isBonus) {
                            score += YELLOW_APPLE_VALUE_MULTIPLIER * REGULAR_APPLE_VALUE * currentMultiplier; // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã¯é«˜å¾—ç‚¹ (å€ç‡é©ç”¨)
                        } else {
                            score += REGULAR_APPLE_VALUE * currentMultiplier; // é€šå¸¸ãƒªãƒ³ã‚´ (å€ç‡é©ç”¨)
                        }
                        rawAppleCount++; // ç”Ÿãƒªãƒ³ã‚´æ•°ã‚’å¢—åŠ ï¼ˆãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ç”Ÿæˆæ•°ç”¨ï¼‰
                        playCollectSound(); // ãƒªãƒ³ã‚´å–å¾—æ™‚ã®åŠ¹æœéŸ³

                        // ã‚¹ã‚³ã‚¢ãŒãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã«é”ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ (ã‚¹ã‚³ã‚¢ã§åˆ¤å®š)
                        while (score >= nextMilestoneScoreTarget) { // è¤‡æ•°ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’ã¾ãŸãå¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§while
                            playMilestoneSound(); // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆæ™‚ã®åŠ¹æœéŸ³
                            // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’å¼·èª¿
                            scoreDisplay.classList.add('text-milestone-highlight');
                            // 0.5ç§’å¾Œã«å¼·èª¿è¡¨ç¤ºã‚’è§£é™¤ (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã«åˆã‚ã›ã¦èª¿æ•´)
                            setTimeout(() => {
                                scoreDisplay.classList.remove('text-milestone-highlight');
                            }, 500);

                            // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã®ç”Ÿæˆæ•°ã‚’è¨­å®š (ã“ã‚Œã¾ã§å–å¾—ã—ãŸãƒªãƒ³ã‚´æ•°)
                            bonusApplesToGenerate += (rawAppleCount / 2); // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã®ç”Ÿæˆæ•°ã‚’åŠæ¸›

                            // ã‚¢ã‚¤ãƒ†ãƒ ã®ç”Ÿæˆé–“éš”ã‚’çŸ­ç¸®ï¼ˆç”Ÿæˆæ•°ã‚’å¢—åŠ ï¼‰
                            currentItemGenerationInterval = Math.max(10, currentItemGenerationInterval * 0.5); 
                            // ã‚¢ã‚¤ãƒ†ãƒ ã®è½ä¸‹é€Ÿåº¦ã‚’ä¸Šæ˜‡ (ç·šå½¢å¢—åŠ )
                            initialItemSpeed = Math.min(MAX_ITEM_SPEED, initialItemSpeed + 0.3); 

                            // å€ç‡ã‚’å¢—åŠ  (å¥¥ã«è¡Œãã»ã©å¢—åŠ é‡ã‚’å¤§ããã™ã‚‹)
                            milestoneCount++; // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆå›æ•°ã‚’å¢—åŠ 
                            currentMultiplier += BASE_MULTIPLIER_INCREASE;
                            currentMultiplier = parseFloat(currentMultiplier.toFixed(1)); // å°æ•°ç‚¹ä»¥ä¸‹1æ¡ã«ä¸¸ã‚ã‚‹

                            // æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®— (åˆæœŸå€¤5ã«20ãšã¤åŠ ç®—ã—ã€å€ç‡ã‚’ã‹ã‘ãŸã‚‚ã®)
                            currentMilestoneBaseRawCount += 20; 
                            nextMilestoneScoreTarget = Math.floor(currentMilestoneBaseRawCount * currentMultiplier); // ãã‚Œã«å€ç‡ã‚’ã‹ã‘ã¦ã‚¹ã‚³ã‚¢ç›®æ¨™ã«ã™ã‚‹
                        }
                        updateScoreDisplay(); // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°

                    } else if (item.type === 'bomb') {
                        gameOver();
                        return; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã£ãŸã‚‰ä»¥é™ã®å‡¦ç†ã¯ä¸è¦
                    }
                    items.splice(i, 1); // è¡çªã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
                }

                // ã‚¢ã‚¤ãƒ†ãƒ ãŒç”»é¢ä¸‹éƒ¨ã‚’é€šéã—ãŸå ´åˆ
                if (item.y > canvas.height / (window.devicePixelRatio || 1)) {
                    items.splice(i, 1); // ç”»é¢å¤–ã«å‡ºãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
                }
            }
        }

        // æç”»å‡¦ç†
        function draw() {
            ctx.clearRect(0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1)); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æç”»
            ctx.fillStyle = '#4299e1'; // é’è‰²
            ctx.fillRect(player.x, player.y, player.width, player.height);
            ctx.strokeStyle = '#2b6cb0'; // æ¿ƒã„é’
            ctx.lineWidth = 2;
            ctx.strokeRect(player.x, player.y, player.width, player.height);
            ctx.fillStyle = 'white';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('å›', player.x + player.width / 2, player.y + player.height / 2 + 5);

            // ã¾ãšãƒªãƒ³ã‚´ã‚’ã™ã¹ã¦æç”»
            items.forEach(item => {
                const itemDrawWidth = ITEM_WIDTH;
                const itemDrawHeight = ITEM_HEIGHT;
                if (item.type === 'apple') {
                    if (item.isBonus) {
                        // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã¯é®®ã‚„ã‹ãªèµ¤
                        ctx.fillStyle = '#FF0000'; // é®®ã‚„ã‹ãªèµ¤
                        ctx.strokeStyle = '#CC0000'; // æ¿ƒã„èµ¤
                    } else {
                        // é€šå¸¸ãƒªãƒ³ã‚´ã¯æš—ã„èµ¤
                        ctx.fillStyle = '#8B0000'; // æš—ã„èµ¤
                        ctx.strokeStyle = '#660000'; // ã•ã‚‰ã«æš—ã„èµ¤
                    }
                    ctx.beginPath();
                    ctx.arc(item.x + itemDrawWidth / 2, item.y + itemDrawHeight / 2, itemDrawWidth / 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // ãƒ˜ã‚¿ã®æç”»
                    ctx.beginPath();
                    ctx.moveTo(item.x + itemDrawWidth / 2, item.y + itemDrawHeight / 2 - itemDrawWidth / 2);
                    ctx.lineTo(item.x + itemDrawWidth / 2 + 5, item.y + itemDrawHeight / 2 - itemDrawWidth / 2 - 10);
                    ctx.strokeStyle = '#10b981'; // ç·‘è‰²
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });

            // æ¬¡ã«çˆ†å¼¾ã‚’ã™ã¹ã¦æç”»ï¼ˆãƒªãƒ³ã‚´ã‚ˆã‚Šä¸Šã«æç”»ã•ã‚Œã‚‹ï¼‰
            items.forEach(item => {
                const itemDrawWidth = ITEM_WIDTH;
                const itemDrawHeight = ITEM_HEIGHT;
                if (item.type === 'bomb') {
                    // çˆ†å¼¾ã®æç”» (èƒŒæ™¯ã‚ˆã‚Šç™½ã«è¿‘ã„è‰²ã«èª¿æ•´)
                    ctx.fillStyle = '#cbd5e0'; // ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼ (èƒŒæ™¯ã®#2d3748ã‚ˆã‚Šã‹ãªã‚Šæ˜ã‚‹ã„)
                    ctx.beginPath();
                    ctx.arc(item.x + itemDrawWidth / 2, item.y + itemDrawHeight / 2, itemDrawWidth / 2, 0, Math.PI * 2);
                    ctx.fill();
                    // æ ç·šã¯å‰Šé™¤
                    // ctx.strokeStyle = '#dc2626';
                    // ctx.lineWidth = 4;
                    // ctx.stroke();

                    // ç«èŠ±ã®å°ç«ç·š
                    ctx.beginPath();
                    ctx.moveTo(item.x + itemDrawWidth / 2, item.y + itemDrawHeight / 2 - itemDrawWidth / 2);
                    ctx.lineTo(item.x + itemDrawWidth / 2 + 5, item.y + itemDrawHeight / 2 - itemDrawWidth / 2 - 10);
                    ctx.strokeStyle = '#f59e0b'; // ã‚ªãƒ¬ãƒ³ã‚¸è‰²
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆé–¢æ•°
        function createItem(type = null, isBonus = false) { // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚¢ã‚¤ãƒ†ãƒ ã®ç¨®é¡ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´
            type = type || (Math.random() < (14/17) ? 'apple' : 'bomb'); // é€šå¸¸ãƒªãƒ³ã‚´ã®ç”Ÿæˆç¢ºç‡ã‚’ç¶­æŒ
            const x = Math.random() * (canvas.width / (window.devicePixelRatio || 1) - ITEM_WIDTH);
            items.push({
                x: x,
                y: -ITEM_HEIGHT, // ç”»é¢ä¸Šéƒ¨ã‹ã‚‰å°‘ã—ä¸Š
                width: ITEM_WIDTH,
                height: ITEM_HEIGHT,
                type: type,
                speed: initialItemSpeed, // ç¾åœ¨ã®è½ä¸‹é€Ÿåº¦ã‚’ä½¿ç”¨
                isBonus: isBonus // ãƒœãƒ¼ãƒŠã‚¹ãƒªãƒ³ã‚´ã‹ã©ã†ã‹
            });
            if (type === 'apple') {
                playAppleSpawnSound(); // ãƒªãƒ³ã‚´ç”Ÿæˆæ™‚ã«åŠ¹æœéŸ³
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            if (e.key === 'ArrowLeft' || e.key === 'a') {
                player.dx = -1;
            } else if (e.key === 'ArrowRight' || e.key === 'd') {
                player.dx = 1;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!gameRunning) return;
            if ((e.key === 'ArrowLeft' || e.key === 'a') && player.dx === -1) {
                player.dx = 0;
            } else if ((e.key === 'ArrowRight' || e.key === 'd') && player.dx === 1) {
                player.dx = 0;
            }
        });

        // ãƒ¢ãƒã‚¤ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ã‚¿ãƒƒãƒé–‹å§‹ã§ç§»å‹•ã€ã‚¿ãƒƒãƒçµ‚äº†ã§åœæ­¢)
        moveLeftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‹•ä½œãªã©ã‚’é˜²æ­¢
            if (gameRunning) player.dx = -1;
        });
        moveLeftBtn.addEventListener('touchend', () => {
            if (player.dx === -1) player.dx = 0;
        });
        moveLeftBtn.addEventListener('touchcancel', () => {
            if (player.dx === -1) player.dx = 0;
        });

        moveRightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‹•ä½œãªã©ã‚’é˜²æ­¢
            if (gameRunning) player.dx = 1;
        });
        moveRightBtn.addEventListener('touchend', () => {
            if (player.dx === 1) player.dx = 0;
        });
        moveRightBtn.addEventListener('touchcancel', () => {
            if (player.dx === 1) player.dx = 0;
        });

        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆPCå‘ã‘ã«ãƒœã‚¿ãƒ³ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆï¼‰
        moveLeftBtn.addEventListener('mousedown', () => {
            if (gameRunning) player.dx = -1;
        });
        moveLeftBtn.addEventListener('mouseup', () => {
            if (player.dx === -1) player.dx = 0;
        });
        moveLeftBtn.addEventListener('mouseleave', () => {
            if (player.dx === -1) player.dx = 0;
        });

        moveRightBtn.addEventListener('mousedown', () => {
            if (gameRunning) player.dx = 1;
        });
        moveRightBtn.addEventListener('mouseup', () => {
            if (player.dx === 1) player.dx = 0;
        });
        moveRightBtn.addEventListener('mouseleave', () => {
            if (player.dx === 1) player.dx = 0;
        });


        // åˆæœŸåŒ–ã‚’ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.onload = initializeGame;

    </script>
</body>
</html>
